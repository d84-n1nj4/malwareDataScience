<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>SafeArray locked but not locked</title>
	<link rel="stylesheet" type="text/css" href="http://85.17.191.244/s/style.eu.4.min.css" />

	<script type="text/javascript">var nk = {conf: {logged_in: false, csrf: '', thread_hash: 'vbRxMQgf'}};</script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js" type="text/javascript" ></script>
	<script src="http://85.17.191.244/s/script.en.min.js" type="text/javascript" ></script>
	
			
	<script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        
        ga('create', 'UA-4696456-11', 'auto');
        ga('set', 'dimension1', 'en');
        ga('set', 'dimension2', 'no');
        ga('set', 'dimension3', 'no');
        ga('set', 'dimension4', 'newsgroup');
        ga('require', 'displayfeatures');
        ga('send', 'pageview');
        	</script>
	        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<script>
		  (adsbygoogle = window.adsbygoogle || []).push({
		    google_ad_client: "ca-pub-2882693173603386",
		    enable_page_level_ads: true
		  });
		</script>
				<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
</head>
<body>


<div id="page_wrapper">
    <div id="header">
        <a href="http://narkive.com/" id="logo">
            <div  id="logo_desc_ng"></div>
            <div style="display: none;"id="logo_desc_ml"></div>
        </a>
        
        
        
        		<a id="nav" href="http://microsoft.public.win32.programmer.ole.narkive.com/">
            	microsoft.public.win32.programmer.ole        </a>
		                <div style="float: left; position: relative;">
            <input type="text" placeholder="Searchâ€¦"  tabindex="1" autocomplete="off" name="search_query" id="top_search" />
            <div id="top_search_res_container" style="display: none;"></div>
        </div>
                <!--<a href="http://narkive.com/user/profile_edit" id="header_user"></a>
        <a href="http://narkive.com/user/profile_settings" id="header_gear"></a>-->
    </div>
<div id="page_container" class="thread">



<script type="text/javascript">
    var adsense_dispatcher_id = 33;
    var adsense_channel_id = '8344924159';
</script>









<div id="thread_container">

	<div id="thread_lister_ctrl">
	    <div style="display: table-cell;">
    	    <div id="thread_lister_subtitle">Discussion:</div>
    		<div id="thread_lister_ctrl_nav">
    			SafeArray locked but not locked    		</div>
		</div>
		<div id="thread_lister_opt">
							(too old to reply)
					</div>
	</div>
	
	
		<div  class="post" id="post1">
	<div class="post_header">
		<div hash="c664e20c76be8b3b" class="post_header_poster">
			Dave		</div>
		<div class="post_header_date">
			<span class="timeago" title="2006-04-19T16:05:46+00:00">2006-04-19 16:05:46 UTC</span>
		</div>
		
	</div>
	<div class="post_body parsed">
		<div class="post_actions"><a href="http://narkive.com/vbRxMQgf.1" class="post_actions_bit" rel="nofollow">Permalink</a><div style="border: 0;" 
class="post_actions_bit post_actions_bit_action_raw">Raw Message</div><!--<div style="border: 0;" class="post_actions_bit post_actions_bit_action_report">Report</div>--></div>
	
    




    
		I'm having an odd problem with a Safe Array.<br /><br />I pass the address of the array into my COM interface from VB using:<br /><br />Dim Arr(20) As Byte<br />MyObj.SomeMethod Arr<br /><br />What I want to do is to redimension the array using SafeArrayRedim.  The odd<br />thing is that SafeArrayRedim is reporting DISP_E_ARRAYISLOCKED even though<br />the cLocks property is showing as zero.  Further, if I try SafeArrayUnlock,<br />that reports E_UNEXPECTED.<br /><br />Anybody any idea what's going on here??<br /><br />Dave<br />
	</div>
</div>

<div id="ads" class="ads_post_bit ads_post_bit_first">


<style>
.adslot_301 { width: 320px; height: 50px; }
@media(min-width: 580px) { .adslot_301 { width: 468px; height: 60px; } }
@media(min-width: 770px) { .adslot_301 { width: 728px; height: 90px; } }

.adslot_301_c, .adslot_302_c, .adslot_303_c { margin-left: auto; margin-right: auto; width: 320px; }
@media(min-width: 580px) { .adslot_301_c, .adslot_302_c, .adslot_303_c { width: auto; } }

.adslot_302, .adslot_303 { width: 320px; height: 100px; }
@media(min-width: 580px) { .adslot_302, .adslot_303 { width: 300px; height: 250px; } }
@media(min-width: 770px) { .adslot_302, .adslot_303 { width: 336px; height: 280px; } }

.adslot_304 { display: none; width: 200px; height: 90px; }
/*@media(min-width: 580px) { .adslot_304 { display: inline-block; } }*/

/*.adslot_304_c { margin-right: 0px; }
@media(min-width: 580px) { .adslot_304_c { margin-left: 50px; display: inline; } }*/

.adslot_305 { display: inline-block; width: 200px; height: 90px; }
/*@media(min-width: 580px) { .adslot_305 { display: none; } }*/

.adslot_305_c { margin: 8px 0px; }
/*@media(min-width: 580px) { .adslot_305_c { margin: 0px; } }*/

</style>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<div class="adslot_301_c">
    <ins class="adsbygoogle adslot_301"
         style="display:inline-block"
         data-ad-client="ca-pub-2882693173603386"
         data-ad-slot="9961258158"></ins>
</div>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
      params: { google_ad_channel: adsense_channel_id}
});
</script>
</div>






<div class="post_wrapper"><div  class="post" id="post2">
	<div class="post_header">
		<div hash="4956d25b1ca4e9bd" class="post_header_poster">
			Brian Muth		</div>
		<div class="post_header_date">
			<span class="timeago" title="2006-04-19T16:16:29+00:00">2006-04-19 16:16:29 UTC</span>
		</div>
		
	</div>
	<div class="post_body parsed">
		<div class="post_actions"><a href="http://narkive.com/vbRxMQgf.2" class="post_actions_bit" rel="nofollow">Permalink</a><div style="border: 0;" 
class="post_actions_bit post_actions_bit_action_raw">Raw Message</div><!--<div style="border: 0;" class="post_actions_bit post_actions_bit_action_report">Report</div>--></div>
	
    




    
		

<div class="quoted_post quoted_post_level_1" ><a href="http://microsoft.public.win32.programmer.ole.narkive.com/vbRxMQgf/safearray-locked-but-not-locked#post1"><i>Post by Dave</i></a><br />I'm having an odd problem with a Safe Array.<br />Dim Arr(20) As Byte<br />MyObj.SomeMethod Arr<br />What I want to do is to redimension the array using SafeArrayRedim.  The<br />odd thing is that SafeArrayRedim is reporting DISP_E_ARRAYISLOCKED even<br />though the cLocks property is showing as zero.  Further, if I try<br />SafeArrayUnlock, that reports E_UNEXPECTED.<br />Anybody any idea what's going on here??<br /></div>Just curious whether the following change makes a difference...<br /><br />Dim Arr() as Byte<br />Redim Arr(20)<br />MyObj.SomeMethod Arr<br /><br />If not, can you post a snippet of code from SomeMethod? I'd like to try to<br />reproduce.<br /><br />Brian<br />
	</div>
</div>
</div>

<div class="post_wrapper"><div class="post_wrapper"><div class="ads_post_bit ads_post_bit_middle">

<div class="adslot_302_c">    
    <ins class="adsbygoogle adslot_302"
         style="display:inline-block"
         data-ad-client="ca-pub-2882693173603386"
         data-ad-slot="9961258158"></ins>
</div>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
      params: { google_ad_channel: adsense_channel_id}
});
</script>


</div>
</div></div>




<div class="post_wrapper"><div  class="post" id="post3">
	<div class="post_header">
		<div hash="8e0901522a27abd0" class="post_header_poster">
			Igor Tandetnik		</div>
		<div class="post_header_date">
			<span class="timeago" title="2006-04-19T16:19:14+00:00">2006-04-19 16:19:14 UTC</span>
		</div>
		
	</div>
	<div class="post_body parsed">
		<div class="post_actions"><a href="http://narkive.com/vbRxMQgf.3" class="post_actions_bit" rel="nofollow">Permalink</a><div style="border: 0;" 
class="post_actions_bit post_actions_bit_action_raw">Raw Message</div><!--<div style="border: 0;" class="post_actions_bit post_actions_bit_action_report">Report</div>--></div>
	
    




    
		

<div class="quoted_post quoted_post_level_1" ><a href="http://microsoft.public.win32.programmer.ole.narkive.com/vbRxMQgf/safearray-locked-but-not-locked#post1"><i>Post by Dave</i></a><br />I'm having an odd problem with a Safe Array.<br />Dim Arr(20) As Byte<br />MyObj.SomeMethod Arr<br />What I want to do is to redimension the array using SafeArrayRedim.<br />The odd thing is that SafeArrayRedim is reporting<br />DISP_E_ARRAYISLOCKED even though the cLocks property is showing as<br />zero.<br /></div>VB makes a fine distinction between fixed size arrays and dynamic<br />arrays. Only the latter can be redim'ed. You declare a dynamic array<br />like this:<br /><br />Dim Arr() As Byte<br />Redim Arr(20)<br /><br />A fixed array is created with FADF_FIXEDSIZE feature flag - that's what<br />SafeArrayRedim is complaining about.<br /><div class="post_signature">--<br />With best wishes,<br />Igor Tandetnik<br /><br />With sufficient thrust, pigs fly just fine. However, this is not<br />necessarily a good idea. It is hard to be sure where they are going to<br />land, and it could be dangerous sitting under them as they fly<br />overhead. -- RFC 1925<br /></div>
	</div>
</div>
</div>




<div class="post_wrapper"><div class="post_wrapper"><div class="ads_post_bit ads_post_bit_middle">

<div class="adslot_304_c">
<ins class="adsbygoogle adslot_304"
     data-ad-client="ca-pub-2882693173603386"
     data-ad-slot="2298390554"></ins>
</div>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
      params: { google_ad_channel: adsense_channel_id}
});
</script>

<div class="adslot_304_c">
<ins class="adsbygoogle adslot_304"
     data-ad-client="ca-pub-2882693173603386"
     data-ad-slot="2298390554"></ins>
</div>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
      params: { google_ad_channel: adsense_channel_id}
});
</script>

<div class="adslot_304_c">
<ins class="adsbygoogle adslot_304"
     data-ad-client="ca-pub-2882693173603386"
     data-ad-slot="2298390554"></ins>
</div>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
      params: { google_ad_channel: adsense_channel_id}
});
</script>


</div>
</div></div>

<div class="post_wrapper"><div  class="post" id="post4">
	<div class="post_header">
		<div hash="c664e20c76be8b3b" class="post_header_poster">
			Dave		</div>
		<div class="post_header_date">
			<span class="timeago" title="2006-04-19T16:41:29+00:00">2006-04-19 16:41:29 UTC</span>
		</div>
		
	</div>
	<div class="post_body parsed">
		<div class="post_actions"><a href="http://narkive.com/vbRxMQgf.4" class="post_actions_bit" rel="nofollow">Permalink</a><div style="border: 0;" 
class="post_actions_bit post_actions_bit_action_raw">Raw Message</div><!--<div style="border: 0;" class="post_actions_bit post_actions_bit_action_report">Report</div>--></div>
	
    




    
		

Thanks for the responses.  You are correct, setting the array up in VB as a<br />dynamic array works fine.<br /><br />To Brian, the code snippet is just the obvious one<br /><br />sabound[0].cElements=101;<br />sabound[0].lLbound=0;<br /><br />hres=SafeArrayRedim(psa,sabound);<br /><br />However, my question now is - how is this "locking"  of a non-dynamic array<br />accomplished?  It is not reflected in the lock count (cLocks) so what is<br />SafeArrayRedim checking that returns the locked condition??<br /><br /><br /><br />Dave<br /><div class="quoted_post quoted_post_level_1" ><a href="http://microsoft.public.win32.programmer.ole.narkive.com/vbRxMQgf/safearray-locked-but-not-locked#post1"><i>Post by Dave</i></a><br />I'm having an odd problem with a Safe Array.<br />Dim Arr(20) As Byte<br />MyObj.SomeMethod Arr<br />What I want to do is to redimension the array using SafeArrayRedim.  The<br />odd thing is that SafeArrayRedim is reporting DISP_E_ARRAYISLOCKED even<br />though the cLocks property is showing as zero.  Further, if I try<br />SafeArrayUnlock, that reports E_UNEXPECTED.<br />Anybody any idea what's going on here??<br />Dave<br /></div>
	</div>
</div>
</div>






<div class="post_wrapper"><div class="post_wrapper"><div  class="post" id="post5">
	<div class="post_header">
		<div hash="8e0901522a27abd0" class="post_header_poster">
			Igor Tandetnik		</div>
		<div class="post_header_date">
			<span class="timeago" title="2006-04-19T17:00:26+00:00">2006-04-19 17:00:26 UTC</span>
		</div>
		
	</div>
	<div class="post_body parsed">
		<div class="post_actions"><a href="http://narkive.com/vbRxMQgf.5" class="post_actions_bit" rel="nofollow">Permalink</a><div style="border: 0;" 
class="post_actions_bit post_actions_bit_action_raw">Raw Message</div><!--<div style="border: 0;" class="post_actions_bit post_actions_bit_action_report">Report</div>--></div>
	
    




    
		

<div class="quoted_post quoted_post_level_1" ><a href="http://microsoft.public.win32.programmer.ole.narkive.com/vbRxMQgf/safearray-locked-but-not-locked#post4"><i>Post by Dave</i></a><br />However, my question now is - how is this "locking"  of a non-dynamic<br />array accomplished?  It is not reflected in the lock count (cLocks)<br />so what is SafeArrayRedim checking that returns the locked condition??<br /></div>Had you actually read my message, you might have found the discussion of<br />FADF_FIXEDSIZE at the bottom helpful.<br /><div class="post_signature">--<br />With best wishes,<br />Igor Tandetnik<br /><br />With sufficient thrust, pigs fly just fine. However, this is not<br />necessarily a good idea. It is hard to be sure where they are going to<br />land, and it could be dangerous sitting under them as they fly<br />overhead. -- RFC 1925<br /></div>	</div>
</div>
</div></div>





<div class="post_wrapper"><div class="post_wrapper"><div class="post_wrapper"><div class="ads_post_bit ads_post_bit_last">

<div class="adslot_303_c"> 
    <ins class="adsbygoogle adslot_303"
         style="display:inline-block"
         data-ad-client="ca-pub-2882693173603386"
         data-ad-slot="9961258158"></ins>
</div>
<script>
(adsbygoogle = window.adsbygoogle || []).push({
      params: { google_ad_channel: adsense_channel_id}
});
</script>

</div>
</div></div></div>
		


	 	 
		
		<script type="text/javascript">
    		$(document).ready(function() {
    		    $.ajax({
    		  			url: "http://" + document.domain +"/ajax/threadviewcounter?hash=vbRxMQgf",
    		  			cache: true,
    		  			type: "GET"
    			});
            });
		</script>












</div>

<div id="sidebar_container">

4 Replies<br />
67 Views
<br />

<span class="sidebar_container_inner">
Switch to linear view 
<br />
<a href="?parse=disable">Disable enhanced parsing</a>
<br />
<a href="http://narkive.com/vbRxMQgf" rel="nofollow">Permalink to this page</a>


</span>





<br /><br />



<div id="thread_navigation">
Thread Navigation<div style="margin-top: 8px;"></div>
<a href="#post1" style="width: 220px;" class="nav_post" id="nav_post1" >
	<div class="post_header">
		<span title="d***@btinternet.com" class="post_header_poster">
			Dave		</span>
		<span class="post_header_date">
			<span class="timeago" title="2006-04-19T16:05:46+00:00">2006-04-19 16:05:46 UTC</span>
		</span>
		
	</div>
</a>
<div class="post_wrapper"><a href="#post2" style="width: 218px;" class="nav_post" id="nav_post2" >
	<div class="post_header">
		<span title="b***@mvps.org" class="post_header_poster">
			Brian Muth		</span>
		<span class="post_header_date">
			<span class="timeago" title="2006-04-19T16:16:29+00:00">2006-04-19 16:16:29 UTC</span>
		</span>
		
	</div>
</a>
</div><div class="post_wrapper"><a href="#post3" style="width: 218px;" class="nav_post" id="nav_post3" >
	<div class="post_header">
		<span title="i***@mvps.org" class="post_header_poster">
			Igor Tandetnik		</span>
		<span class="post_header_date">
			<span class="timeago" title="2006-04-19T16:19:14+00:00">2006-04-19 16:19:14 UTC</span>
		</span>
		
	</div>
</a>
</div><div class="post_wrapper"><a href="#post4" style="width: 218px;" class="nav_post" id="nav_post4" >
	<div class="post_header">
		<span title="d***@btinternet.com" class="post_header_poster">
			Dave		</span>
		<span class="post_header_date">
			<span class="timeago" title="2006-04-19T16:41:29+00:00">2006-04-19 16:41:29 UTC</span>
		</span>
		
	</div>
</a>
</div><div class="post_wrapper"><div class="post_wrapper"><a href="#post5" style="width: 216px;" class="nav_post" id="nav_post5"  style="border-bottom: 1px dashed #8FF1FF;">
	<div class="post_header">
		<span title="i***@mvps.org" class="post_header_poster">
			Igor Tandetnik		</span>
		<span class="post_header_date">
			<span class="timeago" title="2006-04-19T17:00:26+00:00">2006-04-19 17:00:26 UTC</span>
		</span>
		
	</div>
</a>
</div></div> 
</div>






        


</div>







<div style="clear: both"></div>

</div>
<script type="text/javascript">

var nav_highlighted = false,
    sidebar_fixed = false,
    sidebar_initial_top_distance = 0,
    sidebar_initial_left_distance = 0,
    last_post_divs_distance_build = 0,
    post_divs_distances = Array(),
    sidebar_height = 0,
    thread_navigation_height = 0,
    sidebar_position_offset = 0,
    thread_onscroll_timeout = 0,
    sidebar_related_height = 0;

function build_post_divs_distance()
{
    if(new Date().getTime() - last_post_divs_distance_build < 1000)
    {
        return;
    }

    var post_divs = $('.post');

    for(k in post_divs)
    {
        if(parseInt(k) != k)
            continue;
        post_divs_distances[$(post_divs[k]).position().top] = $(post_divs[k]).attr('id').replace('post', '');
    }
    sidebar_height = $('#sidebar_container').height();
    thread_navigation_height = $('#thread_navigation').height();
}


function thread_onscroll()
{
    if($(window).width() < 995)
    {
        return;
    }

    build_post_divs_distance();

    var scroll_top = $(window).scrollTop(),
    sidebar_offset_top = $('#sidebar_container').offset().top,
    windows_height = $(window).height(),
    sidebar_css_top = parseInt($('#sidebar_container').css('top') == 'auto' ? 0 : $('#sidebar_container').css('top')),
    sidebar_standard_top_distance = 20,
    first_visible_post = 1,
    scroller_margins = windows_height < 250 ? 20 : 100;
    highlighted_top_distance = nav_highlighted > 0 ? $('#nav_post' + nav_highlighted).position().top : windows_height/2;

    if(sidebar_initial_left_distance == 0)
    {
        sidebar_initial_left_distance = $('#sidebar_container').offset().left/* == 0 ? 760 : $('#sidebar_container').offset().left*/;
    }

    if(highlighted_top_distance + scroller_margins + sidebar_position_offset + sidebar_related_height > windows_height)
    {
        sidebar_position_offset -= windows_height/2;
        $('#sidebar_container').css('position', 'fixed').css('top', sidebar_position_offset + 'px').css('left', (sidebar_initial_left_distance - 15) + 'px');
    }
    else if(highlighted_top_distance + sidebar_position_offset < scroller_margins)
    {
        sidebar_position_offset += windows_height/2;
        $('#sidebar_container').css('position', 'fixed').css('top', sidebar_position_offset + 'px').css('left', (sidebar_initial_left_distance - 15) + 'px');
    }
    else if(!sidebar_fixed && scroll_top + sidebar_standard_top_distance > sidebar_offset_top)
    {
        $('#sidebar_container').css('position', 'fixed').css('top', '0px').css('left', (sidebar_initial_left_distance - 15) + 'px');
        sidebar_fixed = true;
        sidebar_initial_top_distance = sidebar_offset_top;
    }
    else if(sidebar_fixed && scroll_top + sidebar_standard_top_distance < sidebar_initial_top_distance)
    {
        $('#sidebar_container').css('position', 'relative').css('top', '0').css('left', '0');
        sidebar_fixed = false;
    }

    for(k in post_divs_distances)
        if(k < scroll_top + 100 && post_divs_distances[k] != 'selector')
            first_visible_post = parseInt(post_divs_distances[k]);

    if(first_visible_post > 0 && first_visible_post <= post_divs_distances.length + 1)
    {
        $('#nav_post' + nav_highlighted).css('opacity', '');
        $('#nav_post' + first_visible_post).css('opacity', '1');
        nav_highlighted = first_visible_post;
    }

    clearTimeout(thread_onscroll_timeout);
    thread_onscroll_timeout = setTimeout(function () {thread_onscroll();}, 200);
}

function init_quoted_extra()
{
    $(".quoted_post_level_1").each(function() {
        if($(this).text().length < 500)
            return;

        if($(this).next('.quoted_extra_clickable').length != 0)
            return;

        $(this).css('display', 'none');
        $(this).after('<div class="quoted_extra_clickable">...</div>');
    });
}

function quoted_extra_click(e)
{
    $(e).css('display', 'none');
    $(e).prev().css('display', 'block');

    build_post_divs_distance()
}

function adblock_status(r)
{
    if(!document.addEventListener) {
        return;
    }
    
    if(r == false) {
        ga('send', 'event', 'adblock', 'disabled', {'nonInteraction': 1});
        return;
    }

    ga('send', 'event', 'adblock', 'enabled', {'nonInteraction': 1});

    //return;

    $.get( "http://" + document.domain + "/ajax/banner", function( data ) {
        $( ".adslot_301_c" ).html( data );
        for(var i = 2; i< 5; i++)
            $('.adslot_30' + i + '_c').parent().remove()
    });

}


function thread_check_adv()
{
    if(typeof DetectAdBlock === 'undefined') {
        adblock_status(true);
    } else {
        detectAdBlock.onDetected(function() { adblock_status(true) });
        detectAdBlock.onNotDetected(function() { adblock_status(false) });
    }


//    if(typeof window.google_persistent_state !== 'undefined')
//	    return;
//    $('.ads_post_bit').css('display', 'none');
    }


function thread_selector_mouseup()
{
    
}

function thread_init_selection()
{
    if(!window.location.hash || !window.location.hash.match(/^#selection:([0-9]+)\.([0-9]+)\.([0-9]+)$/))
        return;
    
    var temp = window.location.hash.match(/^#selection:([0-9]+)\.([0-9]+)\.([0-9]+)$/);
    var post = temp[1], start = temp[2], end = parseInt(start) + parseInt(temp[3]), ts, tr;

    tr = $('#post' + post).children('.post_body').html().trim();
    
    ts = '<div>' + $('#post' + post).children('.post_body').html().trim() + '</div>';
    ts = $(ts);
    ts.find('.quoted_post').remove();
    ts.find('.post_signature').remove();
    //ts.find('#selection_url_f').remove();
    ts.find('br').replaceWith(' ');
    ts = ts.html().trim();
    
    var post_verified = '', c;

    for (var i = 0; i < ts.length; i++)
    {
        if(i < start || i >= end)
            continue;
        
        c = ts.charAt(i);
        post_verified += c;
        
        if(c != ' ')
            continue;
        
        if(tr.indexOf(post_verified) != -1)
            continue;
            
        post_verified = post_verified.slice(0, -1);
        
        if(tr.indexOf(post_verified + '<br>') != -1)
        {
            post_verified += '<br>';
            continue;
        }
        
        break;
            
    }
    
    $('#post' + post).children('.post_body').html( $('#post' + post).children('.post_body').html().replace(post_verified, '<span id="init_selection">' + post_verified + '</span>') );
    var offset = (window.innerHeight < $("#init_selection").height()) ? 30 : ((window.innerHeight - $("#init_selection").height()) / 2);
    $('html,body').animate({scrollTop: $("#init_selection").offset().top - offset},'fast');
    
    ga('send', 'event', 'selection', 'load', {'nonInteraction': 1});

}

function thread_init_copy()
{  
  $('#thread_container').on("mouseup", function() {
    var t, te, tr, ts;
    
    if($('#selection_url_c:hover').length > 0)
    {
        $('#selection_url_c input').select();
        ga('send', 'event', 'selection', 'click', {'nonInteraction': 1});
        return;
    }
    
    $('#selection_url_c').remove();
    $('#selection_url_f').remove();
    
    
    if(window.getSelection)
        t = window.getSelection();
    else if(document.getSelection)
        t = document.getSelection();
    else if(document.selection)
        t = document.selection.createRange().text;
    
    if(typeof t === 'undefined' || t.toString().length <= 1)
        return;
        
    if(typeof t.anchorNode === 'undefined' || typeof t.anchorNode.parentElement === 'undefined' || typeof t.anchorNode.parentElement.parentElement === 'undefined')
        return;
    
    te = t.anchorNode.parentElement.parentElement;
    
    if(!te.id.match(/^post[0-9]+$/))
        return;
    
    tr = t.toString().replace(/\n/g, ' ').trim();
    ts = '<div>' + $(te).children('.post_body').html().trim() + '</div>';
    ts = $(ts);
    ts.find('.quoted_post').remove();
    ts.find('.post_signature').remove();
    //ts.find('#selection_url_f').remove();
    ts.find('br').replaceWith(' ');
    ts = ts.html().trim();
    
    if(ts.indexOf(tr) == -1)
        return;
        
    var hash = document.location.href.match(/\.narkive\.com\/([a-zA-Z0-9]{8})/);
        if (typeof hash[1] === 'undefined')
            return;
            
    hash = hash[1];
    
    var fix_index = 0;
    
    if(ts.indexOf('init_selection') < ts.indexOf(tr) && ts.indexOf('init_selection') != -1)
        fix_index = 33;
    
    console.log(ts);
    console.log(fix_index);
    
	var url = 'http://narkive.com/' + hash + ':' + te.id.replace('post', '') + '.' + (ts.indexOf(tr) - fix_index) + '.' + tr.length;
	
	setTimeout(function() {
	    try {
    	    var range = document.createRange();
            range.setStart(t.focusNode, t.focusOffset);
    	    range.insertNode($('<span id="selection_url_f"></span>').get(0));
    	    var selection_button = $('<div style="top: ' + $('#selection_url_f').offset().top + 'px" id="selection_url_c">Selection Permalink:<input type="text" value="'+url+'"></div>').get(0);
            $('#thread_container').append(selection_button);  
            console.log(selection_button);
	    }
	    catch (e) {}
    }, 10);

    
    
  });
}

/*
function thread_similarbar(hash)
{
    if(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent))
        return;
        
    $.get( "http://" + document.domain + "/ajax/similarbar?hash=" + hash, function( data ) {
        $('#thread_navigation').after(data);
    });      
}
*/				

function thread_suggested_reading(hash)
{
    if(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent))
        return;
        
    $.get( "http://" + document.domain + "/ajax/suggestedreading?hash=" + hash, function( data ) {
        $('#thread_container').append(data);
    });      
}
		

$( window ).scroll(function () { thread_onscroll(); });
$( document ).ready(function() { init_quoted_extra(); thread_onscroll(); thread_check_adv(); thread_init_copy(); thread_init_selection(); });
</script>

<script type="text/javascript">
 /*   thread_similarbar('vbRxMQgf');*/
 /* thread_suggested_reading('vbRxMQgf'); */
 
</script>

<style type="text/css">



</style>

<script type="text/javascript">


 
</script>


<div style="height: 50px"></div>	
</div>

<div id="footer_wrapper">
<div id="footer_links">
<a href="http://narkive.com/about">about</a> - <!--<a href="http://narkive.com/contact">contact</a> - <a style="cursor:pointer;" id="uservoice_button">feedback</a> - --><a href="http://narkive.com/legalese">legalese</a>
</div>

<!--
<div id="lang_selector">
<div id="lang_select">Contents in English</div>

<div id="lang_select_cont">
	<div id="lang_select_cont_in">

	<a href="?set_lang=zh" class="lang_select_bit">Chinese</a><a href="?set_lang=hr" class="lang_select_bit">Croatian</a><a href="?set_lang=cs" class="lang_select_bit">Czech</a><a href="?set_lang=da" class="lang_select_bit">Danish</a><a href="?set_lang=nl" class="lang_select_bit">Dutch</a><a href="?set_lang=en" class="lang_select_bit">English</a><a href="?set_lang=et" class="lang_select_bit">Estonian</a><a href="?set_lang=fi" class="lang_select_bit">Finnish</a><a href="?set_lang=fr" class="lang_select_bit">French</a><a href="?set_lang=de" class="lang_select_bit">German</a><a href="?set_lang=el" class="lang_select_bit">Greek</a><a href="?set_lang=he" class="lang_select_bit">Hebrew</a><a href="?set_lang=hu" class="lang_select_bit">Hungarian</a><a href="?set_lang=it" class="lang_select_bit">Italian</a><a href="?set_lang=ja" class="lang_select_bit">Japanese</a><a href="?set_lang=nb" class="lang_select_bit">Norwegian</a><a href="?set_lang=pl" class="lang_select_bit">Polish</a><a href="?set_lang=pt" class="lang_select_bit">Portuguese</a><a href="?set_lang=ru" class="lang_select_bit">Russian</a><a href="?set_lang=sr" class="lang_select_bit">Serbian</a><a href="?set_lang=es" class="lang_select_bit">Spanish</a><a href="?set_lang=sv" class="lang_select_bit">Swedish</a><a href="?set_lang=tr" class="lang_select_bit" style="border-bottom: none;">Turkish</a>	
	</div>
	
	<div id="lang_select_cont_end"></div>
	
</div>




</div>
-->



</div>
<div id="ajax_loading">Loading...</div>

<div id="overflow"></div>

<div id="overflow_message">
	<div id="overflow_message_header">
	</div>
	<div id="overflow_message_content">
	</div>
	<div id="overflow_message_actions">
	</div>
</div>
</body></html>

